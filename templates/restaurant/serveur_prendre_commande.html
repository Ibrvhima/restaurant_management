{% extends 'base/base.html' %}
{% load static %}

{% block title %}Prendre une commande - Table {{ table.numero_table }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <div class="mb-8">
            <div class="flex justify-between items-center">
                <div>
                    <a href="{% url 'restaurant:serveur_table_commandes' table.id %}" class="text-blue-600 hover:text-blue-800 mb-4 inline-block">
                        ← Retour aux commandes
                    </a>
                    <h1 class="text-3xl font-bold text-gray-900">Prendre une commande</h1>
                    <p class="text-gray-600">Table {{ table.numero_table }} - {{ table.nombre_places }} places</p>
                </div>
            </div>
        </div>

        <form method="post" action="{% url 'restaurant:serveur_creer_commande' table.id %}">
            {% csrf_token %}
            
            <!-- Plats service direct -->
            {% if plats_service_direct %}
            <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
                <div class="bg-green-600 text-white p-6">
                    <h2 class="text-xl font-bold">Service direct (pas de préparation)</h2>
                    <p class="text-green-100">Boissons, desserts froids, etc.</p>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {% for plat in plats_service_direct %}
                        <div class="border rounded-lg p-4 hover:bg-gray-50 transition">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-lg">{{ plat.nom }}</h4>
                                    <p class="text-sm text-gray-600">{{ plat.get_type_plat_display }}</p>
                                    {% if plat.categorie %}
                                    <p class="text-sm text-blue-600">{{ plat.categorie.nom }}</p>
                                    {% endif %}
                                </div>
                                <div class="text-right ml-4">
                                    <p class="font-bold text-green-600">{{ plat.prix_unitaire }} GNF</p>
                                </div>
                            </div>
                            
                            <div class="flex items-center space-x-2">
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" name="plats" value="{{ plat.id }}" 
                                           class="mr-2 h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
                                    <span class="text-sm">Ajouter</span>
                                </label>
                                <input type="number" name="quantites" min="1" value="1" 
                                       class="w-16 px-2 py-1 border border-gray-300 rounded focus:ring-green-500 focus:border-green-500"
                                       placeholder="Qté">
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Plats à préparer -->
            {% if plats_a_preparer %}
            <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
                <div class="bg-orange-600 text-white p-6">
                    <h2 class="text-xl font-bold">À préparer en cuisine</h2>
                    <p class="text-orange-100">Plats chauds, entrées, etc.</p>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {% for plat in plats_a_preparer %}
                        <div class="border rounded-lg p-4 hover:bg-gray-50 transition">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-lg">{{ plat.nom }}</h4>
                                    <p class="text-sm text-gray-600">{{ plat.get_type_plat_display }}</p>
                                    {% if plat.categorie %}
                                    <p class="text-sm text-blue-600">{{ plat.categorie.nom }}</p>
                                    {% endif %}
                                </div>
                                <div class="text-right ml-4">
                                    <p class="font-bold text-orange-600">{{ plat.prix_unitaire }} GNF</p>
                                </div>
                            </div>
                            
                            <div class="flex items-center space-x-2">
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" name="plats" value="{{ plat.id }}" 
                                           class="mr-2 h-4 w-4 text-orange-600 focus:ring-orange-500 border-gray-300 rounded">
                                    <span class="text-sm">Ajouter</span>
                                </label>
                                <input type="number" name="quantites" min="1" value="1" 
                                       class="w-16 px-2 py-1 border border-gray-300 rounded focus:ring-orange-500 focus:border-orange-500"
                                       placeholder="Qté">
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Actions -->
            {% if plats_service_direct or plats_a_preparer %}
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="p-6">
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-gray-600">
                            <p id="selectionInfo">Sélectionnez des plats pour voir le total</p>
                        </div>
                        <div class="flex space-x-4">
                            <a href="{% url 'restaurant:serveur_table_commandes' table.id %}" 
                               class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                                Annuler
                            </a>
                            <button type="submit" id="submitBtn" disabled
                                    class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition disabled:bg-gray-300 disabled:cursor-not-allowed">
                                Créer la commande
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('input[name="plats"]');
    const submitBtn = document.getElementById('submitBtn');
    const selectionInfo = document.getElementById('selectionInfo');
    
    function updateSelection() {
        const selectedPlats = document.querySelectorAll('input[name="plats"]:checked');
        let total = 0;
        let itemCount = 0;
        
        selectedPlats.forEach(checkbox => {
            const quantiteInput = checkbox.closest('.border').querySelector('input[name="quantites"]');
            const quantite = parseInt(quantiteInput.value) || 1;
            const price = parseFloat(checkbox.dataset.price || 0);
            total += price * quantite;
            itemCount += quantite;
        });
        
        submitBtn.disabled = selectedPlats.length === 0;
        
        if (selectedPlats.length > 0) {
            selectionInfo.innerHTML = `<strong>${itemCount} article(s) sélectionné(s)</strong> - Total: <span class="text-blue-600 font-bold">${total} GNF</span>`;
        } else {
            selectionInfo.textContent = 'Sélectionnez des plats pour voir le total';
        }
    }
    
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelection);
        
        // Ajouter le prix au dataset
        const priceText = checkbox.closest('.border').querySelector('.font-bold').textContent;
        const price = parseFloat(priceText.replace(' GNF', '').replace(/\s/g, ''));
        checkbox.dataset.price = price;
        
        // Écouter aussi les changements de quantité
        const quantiteInput = checkbox.closest('.border').querySelector('input[name="quantites"]');
        quantiteInput.addEventListener('input', updateSelection);
    });
});
</script>
{% endblock %}
